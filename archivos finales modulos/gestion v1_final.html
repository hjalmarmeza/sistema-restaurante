<!DOCTYPE html>
<html class="dark" lang="es">
<head>
   <meta charset="utf-8"/>
   <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
   <title>Gestión | Restaurante360</title>
   <link href="https://fonts.googleapis.com/icon?family=Material+Symbols+Outlined" rel="stylesheet"/>
   <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
   <script src="https://cdn.tailwindcss.com"></script>
   <script>
       tailwind.config = {
           darkMode: "class",
           theme: { extend: { colors: { primary: "#1392ec", dark: "#0f1115", card: "#1a1d24" } } }
       }
   </script>
</head>
<body class="bg-dark text-white font-sans min-h-screen flex flex-col md:flex-row overflow-hidden">


   <script>
       const CLOUDINARY_CONFIG = {
           cloudName: "dmvkaq9zc",             
           uploadPreset: "restaurante360_preset"
       };
       const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbziajyL10l9cnis2NZ1k4UDCYylbysU-PBNw930e-wRdBpdYeBZHOYhsT5YOhkNKT4O/exec";
   </script>


   <header class="md:hidden flex items-center justify-between p-4 bg-card border-b border-white/5 sticky top-0 z-20">
       <h1 class="text-lg font-bold tracking-tight flex items-center gap-2">
           <span class="material-symbols-outlined text-primary">admin_panel_settings</span> GESTIÓN
       </h1>
       <button onclick="window.location.reload()" class="text-gray-400"><span class="material-symbols-outlined">refresh</span></button>
   </header>


   <nav class="fixed bottom-0 left-0 w-full bg-card border-t border-white/5 z-50 flex justify-around items-center p-2 pb-safe md:relative md:w-64 md:flex-col md:justify-start md:border-t-0 md:border-r md:h-screen md:p-6 md:space-y-4">
       <div class="hidden md:block mb-6 border-b border-white/5 pb-6">
           <h1 class="text-2xl font-bold tracking-tight">GESTIÓN 360</h1>
       </div>
       <button onclick="app.showTab('menu')" id="btn-menu" class="flex flex-col md:flex-row items-center md:gap-3 p-2 md:px-4 md:py-3 rounded-lg text-primary md:bg-primary md:text-white transition-all group">
           <span class="material-symbols-outlined text-2xl md:text-xl">restaurant_menu</span><span class="text-[10px] md:text-base font-bold">MENÚ</span>
       </button>
       <button onclick="app.showTab('staff')" id="btn-staff" class="flex flex-col md:flex-row items-center md:gap-3 p-2 md:px-4 md:py-3 rounded-lg text-gray-400 hover:text-white md:hover:bg-white/5 transition-all group">
           <span class="material-symbols-outlined text-2xl md:text-xl">groups</span><span class="text-[10px] md:text-base font-bold">EQUIPO</span>
       </button>
       <a href="cocina.html" class="hidden md:flex flex-col md:flex-row items-center md:gap-3 p-2 md:px-4 md:py-3 rounded-lg text-gray-400 hover:text-yellow-400 md:hover:bg-white/5 transition-all group mt-auto">
           <span class="material-symbols-outlined text-2xl md:text-xl">skillet</span><span class="text-[10px] md:text-base font-bold">Ir a Cocina</span>
       </a>
   </nav>


   <main class="flex-1 p-4 md:p-8 overflow-y-auto mb-20 md:mb-0">
       <div id="tab-menu" class="space-y-4 animate-fade-in">
           <div class="flex justify-between items-center">
               <h2 class="text-xl md:text-2xl font-bold">Carta Digital</h2>
               <button onclick="app.openModal('modal-menu')" class="bg-primary hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-primary/20 text-sm md:text-base active:scale-95 transition-transform">
                   <span class="material-symbols-outlined text-lg">add</span> Nuevo Plato
               </button>
           </div>
           <div id="menu-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4"></div>
       </div>


       <div id="tab-staff" class="hidden space-y-4 animate-fade-in">
           <div class="flex justify-between items-center">
               <h2 class="text-xl md:text-2xl font-bold">Equipo</h2>
               <button onclick="app.openModal('modal-staff')" class="bg-primary hover:bg-blue-600 text-white px-3 py-2 rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-primary/20 text-sm md:text-base active:scale-95 transition-transform">
                   <span class="material-symbols-outlined text-lg">person_add</span> Nuevo Mozo
               </button>
           </div>
           <div id="staff-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4"></div>
       </div>
   </main>


   <dialog id="modal-staff" class="bg-card text-white p-6 rounded-xl border border-white/10 backdrop:bg-black/80 w-[90%] max-w-md shadow-2xl">
       <form onsubmit="app.saveStaff(event)" class="space-y-4">
           <div class="flex justify-between items-center mb-2">
               <h3 class="text-xl font-bold">Nuevo Colaborador</h3>
               <button type="button" onclick="this.closest('dialog').close()" class="text-gray-400"><span class="material-symbols-outlined">close</span></button>
           </div>
           <div class="flex items-center gap-4 bg-dark p-4 rounded-lg border border-white/10">
               <div id="preview-staff" class="h-20 w-20 rounded-full bg-cover bg-center bg-gray-700 border-2 border-white/10 flex-shrink-0"></div>
               <div class="flex-1">
                   <button type="button" onclick="app.uploadPhoto('preview-staff', 'input-img-staff', 'modal-staff')" class="w-full bg-primary/20 hover:bg-primary/30 text-primary py-2 rounded-lg font-bold flex justify-center gap-2 items-center border border-primary/30 transition-colors">
                       <span class="material-symbols-outlined">photo_camera</span> TOMAR FOTO
                   </button>
               </div>
               <input type="hidden" name="image" id="input-img-staff">
           </div>
           <input type="text" name="name" placeholder="Nombre Completo" class="w-full bg-dark border border-white/10 rounded-lg p-3 text-white outline-none focus:border-primary" required>
           <div class="grid grid-cols-2 gap-3">
               <select name="role" class="w-full bg-dark border border-white/10 rounded-lg p-3 text-white outline-none focus:border-primary">
                   <option value="MOZO">Mozo</option>
                   <option value="COCINA">Cocina</option>
                   <option value="ADMIN">Admin</option>
               </select>
               <input type="tel" name="pin" placeholder="PIN (4)" class="w-full bg-dark border border-white/10 rounded-lg p-3 text-white outline-none text-center tracking-widest" required maxlength="4">
           </div>
           <button type="submit" class="w-full bg-primary py-3 rounded-lg font-bold text-white shadow-lg mt-2">GUARDAR</button>
       </form>
   </dialog>


   <dialog id="modal-menu" class="bg-card text-white p-6 rounded-xl border border-white/10 backdrop:bg-black/80 w-[90%] max-w-md shadow-2xl">
       <form onsubmit="app.saveItem(event)" class="space-y-4">
           <div class="flex justify-between items-center mb-2">
               <h3 class="text-xl font-bold">Nuevo Plato</h3>
               <button type="button" onclick="this.closest('dialog').close()" class="text-gray-400"><span class="material-symbols-outlined">close</span></button>
           </div>
           <div class="flex items-center gap-4 bg-dark p-4 rounded-lg border border-white/10">
               <div id="preview-menu" class="h-16 w-16 rounded-lg bg-cover bg-center bg-gray-700 border border-white/10 flex-shrink-0"></div>
               <button type="button" onclick="app.uploadPhoto('preview-menu', 'input-img-menu', 'modal-menu')" class="w-full bg-white/10 hover:bg-white/20 py-2 rounded-lg font-bold flex justify-center gap-2 items-center text-sm border border-white/20 transition-colors">
                   <span class="material-symbols-outlined">add_a_photo</span> FOTO
               </button>
               <input type="hidden" name="image" id="input-img-menu">
           </div>
           <input type="text" name="category" placeholder="Categoría" class="w-full bg-dark border border-white/10 rounded-lg p-3 text-white outline-none focus:border-primary" required>
           <input type="text" name="name" placeholder="Nombre" class="w-full bg-dark border border-white/10 rounded-lg p-3 text-white outline-none focus:border-primary" required>
           <input type="number" name="price" placeholder="Precio" class="w-full bg-dark border border-white/10 rounded-lg p-3 text-white outline-none focus:border-primary" required>
           <button type="submit" class="w-full bg-primary py-3 rounded-lg font-bold text-white shadow-lg mt-2">GUARDAR</button>
       </form>
   </dialog>


   <script>
       const app = {
           init: () => { app.fetchMenu(); app.fetchStaff(); },
          
           // LOGICA LIMPIA: CIERRA -> ABRE CAMARA -> ABRE MODAL
           uploadPhoto: (previewId, inputId, modalId) => {
               const modal = document.getElementById(modalId);
               modal.close(); // Cierra el modal para que no estorbe


               cloudinary.createUploadWidget({
                   cloudName: CLOUDINARY_CONFIG.cloudName,
                   uploadPreset: CLOUDINARY_CONFIG.uploadPreset,
                   sources: ['local', 'camera'],
                   multiple: false,
                   folder: 'restaurante360',
                   theme: 'minimal',
               }, (error, result) => {
                   if (error || result.event === "success" || result.event === "close") {
                       if (result && result.event === "success") {
                           document.getElementById(inputId).value = result.info.secure_url;
                           document.getElementById(previewId).style.backgroundImage = `url('${result.info.secure_url}')`;
                       }
                       modal.showModal(); // Vuelve a abrir el modal
                   }
               }).open();
           },
          
           showTab: (tabId) => {
               document.getElementById('tab-menu').classList.add('hidden');
               document.getElementById('tab-staff').classList.add('hidden');
               document.getElementById('btn-menu').className = "flex flex-col md:flex-row items-center md:gap-3 p-2 md:px-4 md:py-3 rounded-lg text-gray-400 hover:text-white md:hover:bg-white/5 transition-all group";
               document.getElementById('btn-staff').className = "flex flex-col md:flex-row items-center md:gap-3 p-2 md:px-4 md:py-3 rounded-lg text-gray-400 hover:text-white md:hover:bg-white/5 transition-all group";
               document.getElementById(`btn-${tabId}`).className = "flex flex-col md:flex-row items-center md:gap-3 p-2 md:px-4 md:py-3 rounded-lg text-primary md:bg-primary md:text-white transition-all group";
               document.getElementById(`tab-${tabId}`).classList.remove('hidden');
           },
           openModal: (id) => {
               document.getElementById('preview-menu').style.backgroundImage = '';
               document.getElementById('preview-staff').style.backgroundImage = '';
               document.getElementById(id).showModal();
           },
           fetchMenu: async () => {
               try {
                   const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=get_menu`);
                   const data = await res.json();
                   document.getElementById('menu-list').innerHTML = data.map(i => `
                       <div class="bg-card p-3 rounded-xl border ${i.active ? 'border-white/5' : 'border-red-900/50 opacity-60'} flex gap-3 items-center">
                           <div class="h-16 w-16 rounded bg-cover bg-center bg-gray-700" style="background-image: url('${i.image || 'https://via.placeholder.com/100?text=Menu'}')"></div>
                           <div class="flex-1">
                               <p class="text-[10px] text-primary font-bold uppercase">${i.category}</p>
                               <h3 class="font-bold text-white">${i.name}</h3>
                               <p class="text-gray-400 text-sm">$${i.price}</p>
                           </div>
                           <div class="flex flex-col gap-2">
                               <button onclick="app.toggleItem('${i.id}')" class="${i.active ? 'text-green-500' : 'text-red-500'}"><span class="material-symbols-outlined">power_settings_new</span></button>
                               <button onclick="app.deleteItem('${i.id}')" class="text-red-500"><span class="material-symbols-outlined">delete</span></button>
                           </div>
                       </div>`).join('');
               } catch(e) {}
           },
           fetchStaff: async () => {
               try {
                   const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=get_staff`);
                   const data = await res.json();
                   document.getElementById('staff-list').innerHTML = data.map(s => `
                       <div class="bg-card p-4 rounded-xl border border-white/5 flex items-center justify-between">
                           <div class="flex items-center gap-3">
                               <div class="h-12 w-12 rounded-full bg-cover bg-center border border-white/10" style="background-image: url('${s.image || 'https://cdn-icons-png.flaticon.com/512/847/847969.png'}')"></div>
                               <div>
                                   <h3 class="font-bold text-white">${s.name}</h3>
                                   <span class="text-xs bg-white/10 px-1.5 py-0.5 rounded text-gray-300 uppercase">${s.role}</span>
                               </div>
                           </div>
                           <div class="flex gap-4">
                               <button onclick="app.toggleStaff('${s.id}')" class="${s.active === 'ACTIVO' ? 'text-green-500' : 'text-gray-600'}"><span class="material-symbols-outlined text-2xl">${s.active === 'ACTIVO' ? 'toggle_on' : 'toggle_off'}</span></button>
                               <button onclick="app.deleteStaff('${s.id}')" class="text-red-500"><span class="material-symbols-outlined text-2xl">delete</span></button>
                           </div>
                       </div>`).join('');
               } catch(e) {}
           },
           saveStaff: async (e) => {
               e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.innerText = "Guardando..."; btn.disabled = true;
               const fd = new FormData(e.target);
               await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'add_staff', name: fd.get('name'), role: fd.get('role'), pin: fd.get('pin'), image: document.getElementById('input-img-staff').value }) });
               e.target.reset(); document.getElementById('modal-staff').close(); setTimeout(() => app.fetchStaff(), 1500); btn.innerText = "GUARDAR"; btn.disabled = false;
           },
           saveItem: async (e) => {
               e.preventDefault(); const btn = e.target.querySelector('button[type="submit"]'); btn.innerText = "Guardando..."; btn.disabled = true;
               const fd = new FormData(e.target);
               await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ type: 'add_item', name: fd.get('name'), price: fd.get('price'), category: fd.get('category'), image: document.getElementById('input-img-menu').value }) });
               e.target.reset(); document.getElementById('modal-menu').close(); setTimeout(() => app.fetchMenu(), 1500); btn.innerText = "GUARDAR"; btn.disabled = false;
           },
           deleteStaff: async (id) => { if(confirm("¿ELIMINAR PERMANENTEMENTE?")) { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type: 'delete_staff', id: id}) }); setTimeout(() => app.fetchStaff(), 1000); }},
           deleteItem: async (id) => { if(confirm("¿ELIMINAR PLATO?")) { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type: 'delete_item', id: id}) }); setTimeout(() => app.fetchMenu(), 1000); }},
           toggleStaff: async (id) => { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type: 'toggle_staff', id: id}) }); setTimeout(() => app.fetchStaff(), 1000); },
           toggleItem: async (id) => { await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({type: 'toggle_item', id: id}) }); setTimeout(() => app.fetchMenu(), 1000); }
       };
       app.init();
   </script>
</body>
</html>