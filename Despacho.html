<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Pedidos Listos | Despacho</title>
    <link href="https://fonts.googleapis.com" rel="preconnect"/>
    <link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&family=Noto+Sans:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ecb6", 
                        "primary-dark": "#0d9472",
                        "cold-blue": "#06b6d4",
                        "background-dark": "#0f1115",
                        "card-dark": "#1a1d24",
                        "border-dark": "#2a303b",
                    },
                    fontFamily: { "display": ["Space Grotesk", "sans-serif"], "body": ["Noto Sans", "sans-serif"] },
                    boxShadow: { "neon": "0 0 10px rgba(19, 236, 182, 0.2)" }
                },
            },
        }
    </script>
    <style> .scrollbar-hide::-webkit-scrollbar { display: none; } .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; } </style>
</head>
<body class="bg-[#f6f7f8] dark:bg-background-dark min-h-screen flex flex-col antialiased font-display text-white transition-colors duration-300">

    <header class="sticky top-0 z-50 bg-[#14171c]/95 backdrop-blur-md border-b border-white/5 p-4 flex items-center justify-between shadow-lg">
        <div class="flex items-center gap-4">
            <div class="flex items-center justify-center size-10 rounded-full bg-primary/10 border border-primary/20">
                <span class="material-symbols-outlined text-primary">room_service</span>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white leading-none">ZONA DE PASE</h1>
                <p class="text-xs text-primary font-medium tracking-wide mt-0.5 flex items-center gap-1">
                    <span class="relative flex h-2 w-2"><span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span><span class="relative inline-flex rounded-full h-2 w-2 bg-primary"></span></span>
                    ESPERANDO RECOGIDA
                </p>
            </div>
        </div>
        <button onclick="app.fetchOrders()" class="h-9 px-4 rounded-lg bg-[#232932] border border-white/5 hover:bg-white/5 text-sm font-bold flex items-center gap-2 transition-all">
            <span class="material-symbols-outlined text-[18px]">sync</span> Refrescar
        </button>
    </header>

    <main id="orders-container" class="flex-1 p-4 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 auto-rows-min pb-20">
        <div class="col-span-full flex flex-col items-center justify-center py-20 opacity-50">
            <span class="material-symbols-outlined text-4xl animate-spin mb-4 text-primary">progress_activity</span>
            <p class="text-sm tracking-widest uppercase">Buscando platos...</p>
        </div>
    </main>

    <script>
        const CONFIG = {
            apiUrl: "https://script.google.com/macros/s/AKfycbziajyL10l9cnis2NZ1k4UDCYylbysU-PBNw930e-wRdBpdYeBZHOYhsT5YOhkNKT4O/exec",
            pollInterval: 8000,
            waitKeywords: ['luego', 'postre', 'espera', 'despues', 'turno', 'siguiente'] 
        };

        const app = {
            orders: [],
            ignoredTimestamps: {}, 

            init: () => {
                app.fetchOrders();
                setInterval(() => app.fetchOrders(), CONFIG.pollInterval);
                setInterval(() => app.updateTimers(), 1000);
            },

            fetchOrders: async () => {
                try {
                    const res = await fetch(`${CONFIG.apiUrl}?action=get_ready_orders&t=${Date.now()}`);
                    app.orders = await res.json();
                    app.renderOrders();
                } catch (e) { console.error("Error silencioso fetch", e); }
            },

            deliverOrder: async (id, btn) => {
                if(!confirm("¿Confirmar entrega al mozo?")) return;
                app.ignoredTimestamps[id] = Date.now(); 
                const card = btn.closest('.order-card');
                if(card) card.remove(); 
                app.sendUpdate(id, "ENTREGADO");
            },

            undoOrder: async (id, btn) => {
                if(!confirm("¿Confirmar devolución a Cocina?")) return;
                app.ignoredTimestamps[id] = Date.now(); 
                const card = btn.closest('.order-card');
                if(card) card.remove(); 

                const order = app.orders.find(o => String(o.id) === String(id));
                if (order) {
                    const cleanItems = order.items.replace(/✔|✓/g, '').trim();
                    fetch(CONFIG.apiUrl, {
                        method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify({ type: 'update_items', id: id, newItems: cleanItems })
                    }).then(() => {
                        app.sendUpdate(id, "PENDIENTE");
                    }).catch(e => console.log("Error fondo limpieza", e));
                } else {
                    app.sendUpdate(id, "PENDIENTE");
                }
            },

            sendUpdate: async (id, status) => {
                try {
                    await fetch(CONFIG.apiUrl, {
                        method: 'POST', mode: 'no-cors', headers: {'Content-Type': 'text/plain'},
                        body: JSON.stringify({ type: 'complete_order', id: id, finalStatus: status })
                    });
                } catch(e) { console.error("Error envío fondo", e); }
            },

            // PARSER MEJORADO V27: Acepta "forceReady" para ignorar checks individuales
            parseItemsSmart: (itemsString, forceReady) => {
                let clean = String(itemsString).trim();
                if (clean.startsWith('|')) clean = clean.substring(1);
                const items = []; let currentItem = ""; let bracketDepth = 0;
                for (let i = 0; i < clean.length; i++) { 
                    const char = clean[i]; 
                    if (char === '[') bracketDepth++; 
                    else if (char === ']') bracketDepth--; 
                    if ((char === ',' || char === '|') && bracketDepth === 0) { 
                        if (currentItem.trim()) items.push(currentItem.trim()); 
                        currentItem = ""; 
                    } else { currentItem += char; } 
                }
                if (currentItem.trim()) items.push(currentItem.trim());
                
                return items.map(rawItem => {
                    let name = rawItem.trim();
                    let isChecked = false;
                    
                    // Si tiene check explícito
                    if (name.includes('✔') || name.includes('✓')) { 
                        isChecked = true; 
                        name = name.replace(/✔|✓/g, '').trim(); 
                    }
                    
                    // CORRECCIÓN V27: Si la mesa está LISTA (forceReady), todos son verdes
                    if (forceReady) isChecked = true;

                    const match = name.match(/^(.*?)\s*\[(.*?)\]$/);
                    const cleanName = match ? match[1].trim() : name;
                    const notes = match ? match[2].split(',').map(n => n.trim()) : [];
                    return { name: cleanName, notes, isChecked, original: rawItem };
                });
            },

            renderOrders: () => {
                const container = document.getElementById('orders-container');
                const now = Date.now();

                const visibleOrders = app.orders.filter(o => {
                    const blockedTime = app.ignoredTimestamps[o.id];
                    if (blockedTime && (now - blockedTime < 10000)) return false;
                    return true;
                });

                if (visibleOrders.length === 0) {
                    container.innerHTML = `<div class="col-span-full flex flex-col items-center justify-center py-20 text-gray-500"><span class="material-symbols-outlined text-6xl mb-4">no_meals</span><p class="text-xl font-bold">Barra de Pase Libre</p></div>`;
                    return;
                }

                const uniqueIds = new Set();
                const cleanOrders = visibleOrders.filter(o => {
                    if(uniqueIds.has(o.id)) return false;
                    uniqueIds.add(o.id);
                    return true;
                });

                container.innerHTML = cleanOrders.map(order => {
                    const startTime = new Date(order.time).getTime();
                    
                    // CORRECCIÓN V27: ¿La mesa entera está LISTA?
                    const isOrderFullyReady = (String(order.status).trim() === "LISTO");

                    // Pasamos esa bandera al parser
                    const rawParsed = app.parseItemsSmart(order.items, isOrderFullyReady);
                    
                    const uniqueKeys = new Set();
                    const rawItems = [];
                    rawParsed.forEach(item => {
                        const key = item.name + JSON.stringify(item.notes) + item.isChecked;
                        if (!uniqueKeys.has(key)) { uniqueKeys.add(key); rawItems.push(item); }
                    });

                    // Canibalismo Visual
                    const activeCounts = {};
                    rawItems.forEach(i => {
                        const isWait = i.notes.some(n => CONFIG.waitKeywords.some(k => n.toLowerCase().includes(k)));
                        if (i.isChecked || !isWait) {
                            const key = i.name.toLowerCase().trim();
                            activeCounts[key] = (activeCounts[key] || 0) + 1;
                        }
                    });
                    
                    const itemsHtml = rawItems.filter(item => {
                        const isWait = item.notes.some(n => CONFIG.waitKeywords.some(k => n.toLowerCase().includes(k)));
                        if (isWait && !item.isChecked) {
                            const key = item.name.toLowerCase().trim();
                            if (activeCounts[key] > 0) { activeCounts[key]--; return false; }
                        }
                        return true;
                    }).map(item => {
                        const isWait = item.notes.some(n => CONFIG.waitKeywords.some(k => n.toLowerCase().includes(k)));
                        
                        if (isWait && !item.isChecked) {
                            // AZUL (Solo si NO está checkeado y es de espera)
                            return `<div class="flex items-start gap-2 border-b border-white/5 pb-2 last:border-0 last:pb-0 opacity-80"><span class="material-symbols-outlined text-sm text-cold-blue mt-0.5">hourglass_top</span><div class="flex-1"><p class="text-cold-blue text-sm font-medium leading-snug">${item.name}</p><div class="flex gap-1 mt-0.5"><span class="text-[10px] bg-cold-blue/10 text-cold-blue px-1.5 py-0.5 rounded border border-cold-blue/20 font-bold uppercase tracking-wide">NO SACAR</span>${item.notes.map(n => `<span class="text-[10px] text-gray-400 italic">${n}</span>`).join('')}</div></div></div>`;
                        } else {
                            // VERDE (Checkeado o Mesa Lista)
                            // Limpiamos las notas de espera ("luego") para que se vea limpio
                            const cleanNotes = item.notes.filter(n => !CONFIG.waitKeywords.some(k => n.toLowerCase().includes(k)));
                            
                            return `<div class="flex items-start gap-2 border-b border-white/5 pb-2 last:border-0 last:pb-0"><span class="material-symbols-outlined text-sm text-primary mt-0.5">check_circle</span><div class="flex-1"><p class="text-white text-lg font-bold leading-snug">${item.name}</p>${cleanNotes.length ? `<div class="text-xs text-yellow-500/80 mt-0.5">${cleanNotes.join(', ')}</div>` : ''}</div></div>`;
                        }
                    }).join('');

                    return `<div class="order-card flex flex-col bg-card-dark rounded-xl border border-white/5 overflow-hidden shadow-lg group relative h-fit transition-transform hover:scale-[1.01]" data-time="${startTime}"><div class="absolute top-0 left-0 w-1.5 h-full bg-primary shadow-neon"></div><div class="p-4 pl-6 flex justify-between items-start bg-white/5 border-b border-white/5"><div><div class="flex items-baseline gap-2"><h2 class="text-2xl font-bold text-white tracking-tight">MESA ${order.mesa}</h2><span class="text-sm text-gray-400 font-medium">#${order.id}</span></div><div class="flex items-center gap-1.5 mt-1"><span class="material-symbols-outlined text-gray-500 text-[16px]">person</span><p class="text-xs text-gray-400 font-bold uppercase tracking-wider">${order.mozo}</p></div></div><div class="bg-primary/10 border border-primary/20 px-2 py-1 rounded flex items-center gap-1"><span class="material-symbols-outlined text-primary text-[16px]">timer</span><span class="timer-display text-lg font-bold text-primary font-mono">00:00</span></div></div><div class="p-4 pl-6 flex-1 space-y-3">${itemsHtml}</div><div class="p-3 pl-6 bg-[#1f242d] border-t border-white/5 flex gap-3 mt-auto"><button onclick="app.undoOrder(${order.id}, this)" class="h-12 w-12 flex items-center justify-center rounded-lg border border-white/10 text-gray-400 hover:text-white hover:bg-white/10 transition-colors" title="Devolver a Cocina"><span class="material-symbols-outlined">undo</span></button><button onclick="app.deliverOrder(${order.id}, this)" class="flex-1 h-12 bg-primary hover:bg-white text-background-dark text-base font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-neon active:scale-[0.98]"><span class="material-symbols-outlined">check</span> ENTREGADO</button></div></div>`;
                }).join('');
                app.updateTimers();
            },

            updateTimers: () => {
                const now = new Date().getTime();
                document.querySelectorAll('.order-card').forEach(card => {
                    const startTime = parseInt(card.getAttribute('data-time'));
                    if(!startTime) return;
                    const diff = now - startTime;
                    const minutes = Math.floor(diff / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    const timeString = (minutes < 10 ? "0" + minutes : minutes) + ":" + (seconds < 10 ? "0" + seconds : seconds);
                    const timer = card.querySelector('.timer-display');
                    if(timer) timer.innerText = timeString;
                });
            }
        };
        app.init();
    </script>
</body>
</html>